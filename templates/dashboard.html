{% extends 'base.html' %}
{% block title %}Dashboard - Secure SMS{% endblock %}
{% block content %}
<section class="card">
  <h1>Student Dashboard</h1>
  <p>Welcome back, {{ g.user.username|e }} ({{ g.user.role|e }}).</p>
  <canvas id="gradeChart" width="400" height="200" aria-label="Grade distribution chart"></canvas>
</section>

<section class="card">
  <div class="card-header">
    <h2>Students</h2>
    {% if g.user.role in ['admin', 'teacher'] %}
    <a class="btn-secondary" href="{{ url_for('add_student') }}">Add Student</a>
    {% endif %}
  </div>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Grade</th>
          <th>Notes</th>
          <th>Last Updated</th>
          {% if g.user.role in ['admin', 'teacher'] %}<th>Actions</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for student in students %}
        <tr>
          <td>{{ student.full_name|e }}</td>
          <td>{{ student.email|e }}</td>
          <td>{{ student.grade|e }}</td>
          <td>{{ student.notes|e }}</td>
          <td>{{ student.updated_at|e }}</td>
          {% if g.user.role in ['admin', 'teacher'] %}
          <td>
            <a class="btn-link" href="{{ url_for('edit_student', student_id=student.id) }}">Edit</a>
            {% if g.user.role == 'admin' %}
            <form method="post" action="{{ url_for('delete_student', student_id=student.id) }}" class="inline-form" onsubmit="return confirm('Delete this student?');">
              {{ csrf_token() }}
              <button type="submit" class="btn-link danger">Delete</button>
            </form>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% else %}
        <tr>
          <td colspan="6">No students registered yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>API Access</h2>
  <p>Generate a short-lived JWT for integration with approved systems.</p>
  <form method="post" action="{{ url_for('generate_token') }}">
    {{ api_form.hidden_tag() }}
    {{ api_form.submit(class_='btn-primary') }}
  </form>
</section>

<section class="card">
  <h2>Security Tips</h2>
  <ul>
    <li>Rotate your authenticator secret regularly.</li>
    <li>Use the backup button to export encrypted data securely.</li>
    <li>Review the activity log to monitor suspicious activity.</li>
  </ul>
</section>

{% endblock %}
{% block body_extra %}
<script>
  const gradeData = {{ grade_distribution | tojson }};
  window.renderGradeChart(gradeData);
</script>
{% endblock %}
